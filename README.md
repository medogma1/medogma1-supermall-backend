# Super Mall Backend

## نظرة عامة

هذا هو الخادم الخلفي (Backend) لتطبيق Super Mall، وهو منصة تسوق إلكتروني متكاملة. يوفر هذا الخادم واجهات برمجة التطبيقات (APIs) اللازمة لدعم وظائف التطبيق المختلفة مثل المصادقة، وإدارة المنتجات، والطلبات، والدفع، وغيرها.

## الميزات الرئيسية

- **نظام المصادقة**: تسجيل الدخول، التسجيل، إدارة الملفات الشخصية
- **إدارة المستخدمين**: أدوار متعددة (مسؤول، تاجر، مستخدم عادي)
- **إدارة المنتجات**: إضافة، تعديل، حذف، بحث
- **إدارة الطلبات**: إنشاء، تتبع، تحديث الحالة
- **نظام الدفع**: معالجة المدفوعات
- **إدارة المتاجر**: للتجار
- **التقييمات والمراجعات**: للمنتجات
- **الإشعارات**: للمستخدمين

## حساب المسؤول

### معلومات حساب المسؤول الافتراضي

يتم إنشاء حساب مسؤول افتراضي تلقائيًا عند بدء تشغيل خدمة المصادقة إذا لم يكن موجودًا بالفعل. تفاصيل الحساب هي:

- **اسم المستخدم**: admin
- **البريد الإلكتروني**: admin@supermall.com
- **كلمة المرور**: xx100100
- **الدور**: admin

### ملاحظات حول حساب المسؤول

- تم تخفيف متطلبات كلمة مرور المسؤول بحيث لا تتطلب حروف كبيرة أو صغيرة.
- يمكن تسجيل الدخول باستخدام كلمة المرور بغض النظر عن حالة الأحرف.

## بدء التشغيل

### المتطلبات الأساسية

- Node.js (v14 أو أحدث)
- MySQL
- Redis (اختياري، للتخزين المؤقت)

### إعداد CORS

يستخدم النظام تكوين CORS مرن للسماح بالوصول من تطبيقات الواجهة الأمامية. راجع الوثائق التالية لمزيد من المعلومات:

- [دليل تكوين CORS](./api-gateway/README.md)
- [استكشاف أخطاء CORS وإصلاحها](./CORS_TROUBLESHOOTING.md)

### خطوات التثبيت

1. استنساخ المستودع:
   ```
   git clone https://github.com/yourusername/supermall-backend.git
   cd supermall-backend
   ```

2. تثبيت التبعيات:
   ```
   npm install
   ```

3. إعداد ملف البيئة:
   - قم بإنشاء ملف `.env` في المجلد الرئيسي
   - أضف المتغيرات البيئية المطلوبة (انظر `.env.example`)

4. تشغيل الخادم:
   ```
   npm start
   ```

## الخدمات

يتكون الخادم الخلفي من عدة خدمات مصغرة:

- **خدمة المصادقة**: تدير تسجيل الدخول والتسجيل وإدارة المستخدمين
- **خدمة المنتجات**: تدير المنتجات والفئات
- **خدمة الطلبات**: تدير الطلبات والشحن
- **خدمة المتاجر**: تدير المتاجر والتجار
- **خدمة الدفع**: تدير عمليات الدفع

## التوثيق

للحصول على التوثيق التقني المفصل، يرجى الرجوع إلى:

- **[إرشادات API](API_GUIDELINES.md)**: إرشادات شاملة لتصميم وتطوير وأفضل ممارسات API
- **[توثيق البنية](ARCHITECTURE.md)**: بنية النظام المفصلة، هيكل الخدمات المصغرة، وأنماط التواصل
- **[إرشادات قاعدة البيانات](DATABASE_GUIDELINES.md)**: مبادئ تصميم قاعدة البيانات، أفضل الممارسات، واستراتيجيات التحسين
- **[إرشادات الأمان](SECURITY.md)**: أفضل ممارسات الأمان والتنفيذ
- **[المراقبة](MONITORING.md)**: مراقبة النظام وقابلية الملاحظة
- **[التوسع](SCALING.md)**: استراتيجيات التوسع وتحسين الأداء
- **[CI/CD](CI_CD.md)**: إرشادات التكامل المستمر والنشر
- **[Docker](DOCKER.md)**: الحاويات ونشر Docker

## المساهمة

نرحب بمساهماتكم في تطوير المشروع! يرجى اتباع الإرشادات التالية:

1. **Fork** المشروع وإنشاء فرع جديد للميزة أو الإصلاح
2. اتباع معايير الكود المحددة في `.eslintrc.js`
3. إضافة اختبارات للميزات الجديدة
4. التأكد من نجاح جميع الاختبارات قبل إرسال Pull Request
5. كتابة رسائل commit واضحة ومفصلة

## سجل التغييرات

يمكنك الاطلاع على آخر التحديثات والتحسينات في قسم "التحسينات والتطويرات" أعلاه.

## هيكل المشروع

```
supermall-backend/
├── api-gateway/         # بوابة API الرئيسية (المنفذ 5001)
├── auth-service/        # خدمة المصادقة (المنفذ 5000)
├── user-service/        # خدمة المستخدمين (المنفذ 5002)
├── product-service/     # خدمة المنتجات (المنفذ 5003)
├── order-service/       # خدمة الطلبات (المنفذ 5004)
├── vendor-service/      # خدمة البائعين (المنفذ 5005)
├── support-service/     # خدمة الدعم (المنفذ 5006)
├── chat-service/        # خدمة الدردشة (المنفذ 5007)
├── notification-service/# خدمة الإشعارات (المنفذ 5008)
├── upload-service/      # خدمة التحميل (المنفذ 5009)
├── analytics-service/   # خدمة التحليلات (المنفذ 5010)
└── utils/               # مكتبات مشتركة
    └── auth/            # مكتبة المصادقة المشتركة
```

## مكتبة المصادقة المشتركة

تم تطوير مكتبة مصادقة مشتركة في مجلد `utils/auth` لتوحيد آلية المصادقة عبر جميع الخدمات المصغرة. تتكون المكتبة من:

### authMiddleware.js

يوفر وسائط (middleware) للمصادقة والتحقق من الصلاحيات:

- `authenticate`: للتحقق من صحة رمز JWT وإضافة معلومات المستخدم إلى الطلب
- `restrictTo`: للتحقق من أدوار المستخدم وصلاحياته
- `restrictToOwnerOrAdmin`: للتحقق من ملكية المورد أو صلاحيات المسؤول

### errorHandler.js

يوفر آلية موحدة لمعالجة الأخطاء:

- `createError`: دالة لإنشاء أخطاء مخصصة مع رسالة ونوع ورمز حالة HTTP
- `logError`: دالة لتسجيل الأخطاء مع الطابع الزمني واسم الخدمة ونوع الخطأ
- `handleError`: دالة لمعالجة الأخطاء وإرسال استجابة موحدة
- `errorMiddleware`: وسيط لمعالجة الأخطاء بتنسيق موحد

### responseHandler.js

يوفر هيكل استجابة موحد لجميع الخدمات:

- `successResponse`: لإنشاء استجابة نجاح موحدة
- `errorResponse`: لإنشاء استجابة خطأ موحدة
- `paginatedResponse`: لإنشاء استجابة للبيانات المصفحة

### كيفية الاستخدام

يمكن الاطلاع على التوثيق التفصيلي في ملف `utils/auth/README.md`.

## تشغيل جميع الخدمات

يمكنك تشغيل جميع الخدمات دفعة واحدة باستخدام الأمر:

```
start-all.bat
```

هذا الأمر سيقوم بتشغيل جميع الخدمات المصغرة بالترتيب المناسب مع تعيين متغير البيئة JWT_SECRET إذا لم يكن موجودًا.

## التحسينات والتطويرات

### 1. توحيد قاعدة البيانات
- تم توحيد جميع الخدمات لاستخدام قاعدة بيانات واحدة (`supermall`)
- تم التحويل من MongoDB إلى MySQL للخدمات التي كانت تستخدم MongoDB
- تحسين الأداء والتكامل بين الخدمات

### 2. توحيد تنفيذ المصادقة
- تم استخدام وسيط المصادقة المشترك في جميع الخدمات
- تم تنفيذ آلية موحدة للتحقق من التوكن ومعالجة الأخطاء
- تم إضافة وسيط المصادقة إلى خدمة التحليلات

### 3. تحسين معالجة الأخطاء
- تم استخدام معالج الأخطاء المشترك في جميع الخدمات
- تم توحيد تنسيق رسائل الخطأ وأكواد الحالة

### 4. توحيد هيكل الاستجابة
- تم تطبيق هيكل استجابة موحد في جميع الخدمات
- تم إنشاء وحدة `responseHandler` لتوحيد تنسيق الاستجابات

### 5. تحسينات البنية التحتية
- إعادة هيكلة مجلد `utils` لتوفير مكتبات مشتركة منظمة
- إضافة سكربتات تشغيل محسنة (`start-all.js`, `start-services.js`)
- تحسين إدارة المتغيرات البيئية

### 6. تحسينات تجربة المطور
- إضافة ملفات تكوين للمحرر (`.editorconfig`, `.gitattributes`)
- تحديث `package.json` بسكربتات مفيدة
- إضافة أدوات تشخيص ومعالجة المشاكل

## سكربتات NPM المتاحة

```bash
npm run start:all      # تشغيل جميع الخدمات
npm run start:services # تشغيل خدمات محددة
npm run start:core     # تشغيل الخدمات الأساسية فقط
npm run start:shop     # تشغيل خدمات المتجر فقط
npm run test           # تشغيل الاختبارات
npm run lint           # فحص جودة الكود
npm run diagnose       # تشخيص المشروع
npm run reinstall      # إعادة تثبيت التبعيات
```

## حل مشكلة ECONNRESET

### المشكلة

قد تواجه خطأ `ECONNRESET` (socket hang up) عند محاولة التسجيل أو تسجيل الدخول عبر بوابة API. هذا الخطأ يحدث عندما يتم قطع الاتصال بين بوابة API وخدمة المصادقة قبل اكتمال الطلب.

```
[HPM] ECONNRESET: Error: socket hang up
    at Socket.socketOnEnd (node:_http_client:542:25)
    at Socket.emit (node:events:530:35)
    at endReadableNT (node:internal/streams/readable:1698:12)
    at process.processTicksAndRejections (node:internal/process/task_queues:90:21) {
  code: 'ECONNRESET'
}
```

### الأسباب المحتملة

1. **مهلة اتصال قصيرة**: إعدادات مهلة الاتصال الافتراضية قصيرة جدًا
2. **مشاكل في الشبكة**: تأخير أو انقطاع في الشبكة
3. **تحميل زائد على الخادم**: خدمة المصادقة مشغولة أو تستغرق وقتًا طويلاً للرد
4. **تكوين وكيل (proxy) غير صحيح**: إعدادات وكيل HTTP غير مناسبة

### الحل السريع

لإصلاح المشكلة بسرعة، يمكنك استخدام سكربت الإصلاح التلقائي:

**في نظام Windows:**
```
fix-connection.bat
```

**في نظام Linux/Mac:**
```
chmod +x fix-connection.sh
./fix-connection.sh
```

هذا السكربت سيقوم تلقائيًا بـ:
1. إيقاف خدمات بوابة API وخدمة المصادقة
2. عمل نسخة احتياطية من ملف تكوين بوابة API
3. تطبيق الإصلاحات اللازمة
4. إعادة تشغيل الخدمات
5. اختبار الاتصال للتأكد من حل المشكلة

### الحلول التفصيلية

#### 1. استخدام سكربتات التشخيص والإصلاح

تم إضافة سكربتات جديدة في مجلد `scripts` لتشخيص وإصلاح هذه المشكلة:

- **test-connection.js**: لاختبار الاتصال بين بوابة API وخدمة المصادقة
  ```bash
  node scripts/test-connection.js
  ```

- **fix-gateway-connection.js**: لإصلاح مشكلة الاتصال مؤقتًا
  ```bash
  node scripts/fix-gateway-connection.js
  ```

- **restart-services.js**: لإعادة تشغيل بوابة API وخدمة المصادقة
  ```bash
  node scripts/restart-services.js
  ```

- **network-diagnostics.js**: لتشخيص مشاكل الشبكة
  ```bash
  node scripts/network-diagnostics.js
  ```

- **apply-fixes.js**: لتطبيق الإصلاحات تلقائيًا
  ```bash
  node scripts/apply-fixes.js
  ```

- **restore-original.js**: لاستعادة الإعدادات الأصلية
  ```bash
  node scripts/restore-original.js
  ```

#### 2. تعديل إعدادات وكيل HTTP في بوابة API

تم تحديث ملف `api-gateway/index.js` لزيادة مهلة الاتصال وتمكين خيار `keepAlive`:

```javascript
const http = require('http');
const { createProxyMiddleware } = require('http-proxy-middleware');

// إعدادات وكيل محسنة
const authProxy = createProxyMiddleware({
  target: 'http://localhost:5000',
  changeOrigin: true,
  timeout: 30000,           // زيادة مهلة الاتصال إلى 30 ثانية
  proxyTimeout: 30000,      // زيادة مهلة الوكيل إلى 30 ثانية
  followRedirects: true,    // اتباع إعادة التوجيه
  agent: new http.Agent({   // وكيل HTTP مخصص
    keepAlive: true,        // تمكين keepAlive
    maxSockets: 100,        // زيادة عدد المقابس
    keepAliveMsecs: 60000,  // مدة keepAlive (60 ثانية)
    timeout: 60000,         // مهلة المقبس (60 ثانية)
  }),
  onError: (err, req, res) => {
    console.error('[Proxy Error]', err);
    res.status(500).send('خطأ في الاتصال بالخدمة');
  }
});

app.use('/auth', authProxy);
```

#### 3. التحقق من حالة خدمة المصادقة

تأكد من أن خدمة المصادقة تعمل بشكل صحيح:

```bash
curl http://localhost:5000/health
```

#### 4. زيادة مستوى التسجيل

قم بزيادة مستوى التسجيل في بوابة API وخدمة المصادقة للحصول على معلومات أكثر تفصيلاً:

```bash
DEBUG=express:*,http-proxy-middleware:* node api-gateway/index.js
```

للمزيد من المعلومات، راجع ملف `scripts/README.md`.