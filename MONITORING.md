# استراتيجية المراقبة والتسجيل في Super Mall Backend

هذا المستند يوضح استراتيجية المراقبة وتسجيل الأحداث في مشروع Super Mall Backend، ويقدم إرشادات للمطورين حول كيفية تنفيذ وتكوين أدوات المراقبة والتسجيل.

## جدول المحتويات

- [نظرة عامة](#نظرة-عامة)
- [تسجيل الأحداث (Logging)](#تسجيل-الأحداث-logging)
  - [مستويات التسجيل](#مستويات-التسجيل)
  - [تنسيق السجلات](#تنسيق-السجلات)
  - [تخزين السجلات](#تخزين-السجلات)
- [مراقبة الأداء](#مراقبة-الأداء)
  - [مقاييس الأداء الرئيسية](#مقاييس-الأداء-الرئيسية)
  - [أدوات المراقبة](#أدوات-المراقبة)
- [تنبيهات وإشعارات](#تنبيهات-وإشعارات)
- [مراقبة الخدمات](#مراقبة-الخدمات)
- [استكشاف الأخطاء وإصلاحها](#استكشاف-الأخطاء-وإصلاحها)
- [أفضل الممارسات](#أفضل-الممارسات)
- [التكامل مع CI/CD](#التكامل-مع-cicd)
- [الموارد](#الموارد)

## نظرة عامة

تعتمد استراتيجية المراقبة والتسجيل في Super Mall Backend على عدة مستويات:

1. **تسجيل الأحداث**: تسجيل معلومات تفصيلية عن عمليات التطبيق والأخطاء
2. **مراقبة الأداء**: تتبع مقاييس الأداء الرئيسية مثل وقت الاستجابة واستخدام الموارد
3. **مراقبة الصحة**: التحقق من توفر الخدمات وصحتها
4. **التنبيهات**: إرسال إشعارات عند حدوث مشكلات

## تسجيل الأحداث (Logging)

### مستويات التسجيل

نستخدم مكتبة Winston لتسجيل الأحداث مع المستويات التالية:

- **ERROR**: أخطاء تؤثر على وظائف النظام الأساسية
- **WARN**: مشكلات محتملة تحتاج إلى انتباه
- **INFO**: معلومات عامة عن عمليات النظام
- **DEBUG**: معلومات تفصيلية للتشخيص (في بيئة التطوير فقط)

### تنسيق السجلات

يتم تنسيق السجلات بتنسيق JSON لتسهيل التحليل، ويتضمن كل سجل:

- الطابع الزمني (بتنسيق ISO)
- مستوى التسجيل
- اسم الخدمة
- رسالة
- معرف الطلب (لتتبع الطلبات عبر الخدمات)
- معلومات إضافية (مثل بيانات الخطأ)

### تخزين السجلات

تُخزن السجلات في:

- **بيئة التطوير**: ملفات محلية في مجلد `logs/`
- **بيئة الإنتاج**: مزيج من:
  - ملفات محلية مع تناوب السجلات
  - خدمة ELK Stack (Elasticsearch, Logstash, Kibana) للتحليل المتقدم

## مراقبة الأداء

### مقاييس الأداء الرئيسية

nنقوم بمراقبة المقاييس التالية لكل خدمة:

- **وقت الاستجابة**: متوسط وحد أقصى لوقت استجابة الطلبات
- **معدل الطلبات**: عدد الطلبات في الثانية
- **معدل الأخطاء**: نسبة الطلبات التي تنتهي بأخطاء
- **استخدام الموارد**: استخدام وحدة المعالجة المركزية والذاكرة
- **وقت استجابة قاعدة البيانات**: وقت تنفيذ الاستعلامات

### أدوات المراقبة

- **PM2**: لمراقبة عمليات Node.js وإعادة تشغيلها تلقائيًا
- **Prometheus**: لجمع وتخزين مقاييس الأداء
- **Grafana**: لعرض لوحات المعلومات وتحليل البيانات

## تنبيهات وإشعارات

يتم إعداد تنبيهات للحالات التالية:

- توقف أي خدمة عن العمل
- ارتفاع معدل الأخطاء عن 5%
- تجاوز وقت الاستجابة لـ 2 ثانية
- استخدام الذاكرة أكثر من 80%

يتم إرسال التنبيهات عبر:

- البريد الإلكتروني
- Slack
- رسائل SMS (للتنبيهات الحرجة)

## مراقبة الخدمات

### نقاط فحص الصحة

كل خدمة توفر نقطة نهاية `/health` تقدم معلومات عن:

- حالة الخدمة
- الاتصال بقاعدة البيانات
- الاتصال بالخدمات الأخرى
- استخدام الموارد

### مراقبة التوفر

nنستخدم أداة مراقبة خارجية لفحص توفر الخدمات كل دقيقة وإرسال تنبيهات عند حدوث مشكلات.

## استكشاف الأخطاء وإصلاحها

### تتبع الطلبات

كل طلب يحصل على معرف فريد يتم تمريره عبر جميع الخدمات لتسهيل تتبع مسار الطلب.

### تحليل السجلات

نستخدم Kibana لتحليل السجلات وإنشاء لوحات معلومات مخصصة للمساعدة في تحديد المشكلات.

## أفضل الممارسات

### للمطورين

- استخدم مكتبة التسجيل المشتركة `utils/logger.js`
- سجل بداية ونهاية العمليات المهمة
- تجنب تسجيل البيانات الحساسة (كلمات المرور، بيانات الدفع)
- استخدم المستوى المناسب للتسجيل

### لمشرفي النظام

- مراجعة السجلات والتنبيهات بانتظام
- ضبط عتبات التنبيه بناءً على أنماط الاستخدام
- الاحتفاظ بالسجلات لمدة 30 يومًا على الأقل

## التكامل مع CI/CD

- اختبارات الأداء التلقائية في خط أنابيب CI/CD
- مراقبة الأداء بعد النشر
- التراجع التلقائي إذا تم اكتشاف مشكلات أداء بعد النشر

## الموارد

### مكتبات وأدوات

- [Winston](https://github.com/winstonjs/winston) - مكتبة تسجيل الأحداث
- [PM2](https://pm2.keymetrics.io/) - مدير عمليات Node.js
- [Prometheus](https://prometheus.io/) - نظام مراقبة ومنبه مفتوح المصدر
- [Grafana](https://grafana.com/) - منصة تحليل ولوحات معلومات
- [ELK Stack](https://www.elastic.co/elastic-stack) - Elasticsearch, Logstash, Kibana

### ملفات المشروع ذات الصلة

- `utils/logger.js` - مكتبة التسجيل المشتركة
- `ecosystem.config.js` - تكوين PM2
- `utils/monitoring/` - سكربتات وتكوينات المراقبة

---

## الخطوات التالية

- تنفيذ تكامل مع خدمة APM (مراقبة أداء التطبيق)
- إضافة مراقبة تجربة المستخدم النهائي
- تحسين تحليلات الأمان وكشف التهديدات